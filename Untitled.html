<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Fitness Logger</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">ðŸ’ª Workout Tracker</h1>
        <p class="text-gray-500 mb-6">Log your lifts and track your progress over time.</p>

        <!-- Loading/Error Indicator -->
        <div id="status-message" class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg mb-6 hidden">
            Initializing application...
        </div>

        <!-- User Information -->
        <div class="mb-6 p-3 bg-gray-50 rounded-lg text-sm text-gray-600 border-l-4 border-indigo-400">
            Authenticated User ID: <span id="user-id" class="font-mono text-gray-800 break-all text-xs md:text-sm">...</span>
        </div>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="showView('log')" id="tab-log" class="py-3 px-6 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 hover:text-indigo-800 transition duration-150">Log Workout</button>
            <button onclick="showView('history')" id="tab-history" class="py-3 px-6 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition duration-150">History & Compare</button>
        </div>

        <!-- 1. Log Workout View -->
        <div id="view-log" class="view-content">
            <form id="log-form" class="space-y-4">
                <div>
                    <label for="exercise" class="block text-sm font-medium text-gray-700">Exercise Name (e.g., Bench Press, Squat)</label>
                    <input type="text" id="exercise" required placeholder="Bench Press, Squat, Run" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Sets Container -->
                <div id="sets-container" class="space-y-3 border border-dashed border-indigo-300 p-4 rounded-lg bg-indigo-50">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="text-md font-bold text-indigo-800">Sets Details</h3>
                    </div>
                    <!-- Set rows will be dynamically added here -->
                </div>

                <button type="button" onclick="addSetRow()" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Add Another Set</span>
                </button>

                <button type="submit" id="log-button" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 disabled:opacity-50" disabled>
                    Log Workout
                </button>
                <p id="form-feedback" class="text-sm text-center text-green-600 mt-2 hidden"></p>
            </form>
        </div>

        <!-- 2. History & Compare View -->
        <div id="view-history" class="view-content hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Workout History</h2>

            <!-- Filter Buttons -->
            <div class="flex space-x-2 mb-4">
                <button onclick="setFilter('all')" class="filter-btn bg-indigo-600 text-white px-3 py-1 text-sm rounded-full transition duration-150">All Time</button>
                <button onclick="setFilter('week')" class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full hover:bg-gray-300 transition duration-150">Last 7 Days</button>
                <button onclick="setFilter('month')" class="filter-btn bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-full hover:bg-gray-300 transition duration-150">Last 30 Days</button>
            </div>

            <!-- Comparison Statistics -->
            <div id="comparison-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Stats will be populated here -->
            </div>

            <!-- Workout List -->
            <div id="workout-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <p class="text-gray-500 text-center" id="empty-state">No workouts logged yet. Start logging in the other tab!</p>
                <!-- Workouts will be listed here -->
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let allWorkouts = []; // Cache all workouts for comparison
        let currentFilter = 'all';

        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id');
        const logButton = document.getElementById('log-button');
        const logForm = document.getElementById('log-form');
        const feedbackMessage = document.getElementById('form-feedback');
        const workoutList = document.getElementById('workout-list');
        const comparisonStats = document.getElementById('comparison-stats');
        const emptyState = document.getElementById('empty-state');
        const setsContainer = document.getElementById('sets-container'); // New reference

        // --- Utility Functions ---

        function showMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            statusMessage.classList.add(isError ? 'bg-red-100' : 'bg-yellow-100', isError ? 'text-red-800' : 'text-yellow-800');
            if (!isError) {
                // Hide success/info messages after a few seconds
                setTimeout(() => statusMessage.classList.add('hidden'), 5000);
            }
        }

        // Helper to format Date objects
        function formatDate(timestamp) {
            const date = timestamp instanceof Timestamp ? timestamp.toDate() : timestamp;
            return date.toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // --- Authentication and Initialization ---

        async function initFirebase() {
            if (!firebaseConfig) {
                showMessage("ERROR: Firebase configuration is missing. Cannot initialize application.", true);
                return;
            }

            setLogLevel('debug'); // Enable Firestore logging
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        logButton.disabled = false;
                        showMessage("Successfully connected to Firebase. Ready to log workouts.", false);
                        setupFirestoreListener(); // Start listening for data
                        statusMessage.classList.add('hidden'); // Hide status message on success
                        addSetRow(); // Add the initial set row
                    } else {
                        showMessage("Authentication failed. Please check environment settings.", true);
                        userIdDisplay.textContent = 'Not Authenticated';
                    }
                });
            } catch (error) {
                showMessage(`Authentication error: ${error.message}`, true);
                console.error("Firebase Auth Error:", error);
            }
        }

        // --- Dynamic Set Input Handling ---

        function updateSetNumbers() {
            const rows = setsContainer.querySelectorAll('.set-row');
            rows.forEach((row, index) => {
                const label = row.querySelector('.set-label');
                if (label) {
                    label.textContent = `Set ${index + 1}`;
                }
                const removeBtn = row.querySelector('.remove-set-btn');
                removeBtn.disabled = rows.length === 1; // Cannot remove the last set
            });
        }

        function addSetRow() {
            const newRow = document.createElement('div');
            newRow.className = 'set-row grid grid-cols-12 gap-3 items-end p-2 bg-white rounded-md shadow-sm border border-gray-100';
            newRow.innerHTML = `
                <div class="col-span-2">
                    <p class="text-sm font-bold text-indigo-700 set-label"></p>
                </div>
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500">Weight (kg/lbs)</label>
                    <input type="number" name="weight" min="1" placeholder="e.g., 100" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                </div>
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500">Reps/Duration</label>
                    <input type="text" name="reps" placeholder="e.g., 8 reps or 30 mins" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                </div>
                <div class="col-span-2">
                    <button type="button" onclick="removeSet(this)" class="remove-set-btn w-full py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150 text-sm" title="Remove Set">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            setsContainer.appendChild(newRow);
            updateSetNumbers();
        }

        window.addSetRow = addSetRow;

        function removeSet(buttonElement) {
            const row = buttonElement.closest('.set-row');
            if (setsContainer.querySelectorAll('.set-row').length > 1) {
                row.remove();
                updateSetNumbers();
            }
        }

        window.removeSet = removeSet;

        // --- Data Persistence (Firestore) ---

        function getCollectionPath() {
            // Private data storage path: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/workouts`;
        }

        async function saveWorkout(data) {
            if (!userId) {
                showMessage("Authentication not ready. Please wait.", true);
                return;
            }
            try {
                const path = getCollectionPath();
                await addDoc(collection(db, path), {
                    ...data,
                    timestamp: Timestamp.now()
                });
                return true;
            } catch (error) {
                showMessage(`Failed to save workout: ${error.message}`, true);
                console.error("Firestore Save Error:", error);
                return false;
            }
        }

        async function deleteWorkout(id) {
            if (!userId) return;
            try {
                const path = getCollectionPath();
                await deleteDoc(doc(db, path, id));
                showMessage("Workout deleted successfully!", false);
            } catch (error) {
                showMessage(`Failed to delete workout: ${error.message}`, true);
                console.error("Firestore Delete Error:", error);
            }
        }


        // Set up real-time listener for workouts
        function setupFirestoreListener() {
            if (!db || !userId) return;

            const path = getCollectionPath();
            // Query: Get all documents, ordered by timestamp descending (newest first)
            const workoutsQuery = query(collection(db, path), orderBy("timestamp", "desc"));

            // onSnapshot provides real-time updates
            onSnapshot(workoutsQuery, (snapshot) => {
                const fetchedWorkouts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                allWorkouts = fetchedWorkouts; // Update the cache
                renderWorkouts(); // Re-render the UI based on current filter
            }, (error) => {
                showMessage(`Error fetching real-time data: ${error.message}`, true);
                console.error("Firestore Listener Error:", error);
            });
        }


        // --- UI Rendering and Logic ---

        function showView(viewName) {
            document.querySelectorAll('.view-content').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('border-indigo-600', 'text-indigo-600');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${viewName}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${viewName}`).classList.add('border-indigo-600', 'text-indigo-600');

            if (viewName === 'history') {
                renderWorkouts(); // Ensure history is updated when view is opened
            }
        }

        window.showView = showView; // Make globally accessible

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(filter === 'all' ? 'all time' : filter === 'week' ? '7 days' : '30 days')) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-indigo-600', 'text-white');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            renderWorkouts();
        }

        window.setFilter = setFilter; // Make globally accessible

        function getFilteredWorkouts() {
            const now = new Date().getTime();
            let cutoffTime = 0;

            if (currentFilter === 'week') {
                cutoffTime = now - (7 * 24 * 60 * 60 * 1000); // 7 days ago
            } else if (currentFilter === 'month') {
                cutoffTime = now - (30 * 24 * 60 * 60 * 1000); // 30 days ago
            }

            return allWorkouts.filter(w => {
                // Handle older/corrupted data that might not have a proper timestamp structure
                if (!w.timestamp || typeof w.timestamp.toDate !== 'function') return false;

                const workoutTime = w.timestamp.toDate().getTime();
                return currentFilter === 'all' || workoutTime > cutoffTime;
            });
        }

        function calculateComparisonStats(workouts) {
            if (workouts.length === 0) {
                return {
                    totalLogs: 0,
                    uniqueExercises: 0,
                    heavyLift: { exercise: 'N/A', weight: 0 }
                };
            }

            const totalLogs = workouts.length;
            const uniqueExercises = new Set(workouts.map(w => w.exercise)).size;

            let heaviestLift = { exercise: 'N/A', weight: 0 };

            // Iterate over all workouts, and for each workout, iterate over all sets
            workouts.forEach(w => {
                // Ensure w.sets is an array before trying to iterate
                if (Array.isArray(w.sets)) {
                    w.sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        if (!isNaN(weight) && weight > heaviestLift.weight) {
                            heaviestLift = {
                                exercise: w.exercise, // The exercise name from the parent workout
                                weight: weight
                            };
                        }
                    });
                }
            });

            return { totalLogs, uniqueExercises, heaviestLift };
        }

        function renderComparisonStats(stats) {
            // Added a defensive fallback for heavyLift to prevent TypeError
            const heavyLift = stats.heavyLift || { exercise: 'N/A', weight: 0 };

            comparisonStats.innerHTML = `
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-xs font-medium text-blue-600">Total Exercise Logs</p>
                    <p class="text-2xl font-bold text-blue-800">${stats.totalLogs}</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-xs font-medium text-green-600">Unique Exercises</p>
                    <p class="text-2xl font-bold text-green-800">${stats.uniqueExercises}</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <p class="text-xs font-medium text-purple-600">Heaviest Set Weight</p>
                    <p class="text-xl font-bold text-purple-800 truncate">${heavyLift.weight} (${heavyLift.exercise})</p>
                </div>
            `;
        }


        function renderWorkouts() {
            const filteredWorkouts = getFilteredWorkouts();
            const stats = calculateComparisonStats(filteredWorkouts);
            renderComparisonStats(stats);

            if (filteredWorkouts.length === 0) {
                workoutList.innerHTML = '<p class="text-gray-500 text-center p-4">No workouts found for this period.</p>';
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            const html = filteredWorkouts.map(workout => {
                // Handle cases where 'sets' might not be an array (for new data structure consistency)
                const sets = Array.isArray(workout.sets) ? workout.sets : [];

                const setsHtml = sets.map((set, index) => `
                    <div class="flex justify-between text-sm text-gray-600 py-0.5 border-b border-gray-100 last:border-b-0">
                        <span class="font-medium text-indigo-700 w-1/5">Set ${index + 1}:</span>
                        <span class="w-2/5">${set.weight} kg/lbs</span>
                        <span class="w-2/5">${set.reps}</span>
                    </div>
                `).join('');

                return `
                    <div class="p-4 bg-white rounded-lg border shadow-md">
                        <div class="flex items-start justify-between mb-2 pb-2 border-b border-gray-200">
                            <div>
                                <p class="text-xl font-bold text-indigo-700">${workout.exercise}</p>
                                <p class="text-xs text-gray-500">${formatDate(workout.timestamp)}</p>
                            </div>
                            <button onclick="deleteWorkout('${workout.id}')"
                                    class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150"
                                    title="Delete Log">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-1">
                            <div class="flex justify-between text-xs font-semibold text-gray-800 bg-gray-100 p-1 rounded-sm">
                                <span class="w-1/5">SET</span>
                                <span class="w-2/5">WEIGHT</span>
                                <span class="w-2/5">REPS/DURATION</span>
                            </div>
                            ${setsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            workoutList.innerHTML = html;
        }

        window.deleteWorkout = deleteWorkout; // Make globally accessible

        // --- Event Listeners ---

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            logButton.disabled = true;
            logButton.textContent = 'Logging...';
            feedbackMessage.classList.add('hidden');

            const exercise = document.getElementById('exercise').value.trim();
            const setRows = setsContainer.querySelectorAll('.set-row');

            const sets = Array.from(setRows).map(row => {
                return {
                    weight: row.querySelector('input[name="weight"]').value,
                    reps: row.querySelector('input[name="reps"]').value.trim()
                };
            }).filter(set => set.weight && set.reps); // Only include sets that have both values

            if (sets.length === 0) {
                logButton.disabled = false;
                logButton.textContent = 'Log Workout';
                showMessage("Please add at least one valid set to log.", true);
                return;
            }

            const workoutData = {
                exercise: exercise,
                sets: sets // Store the array of sets
            };

            const success = await saveWorkout(workoutData);

            if (success) {
                feedbackMessage.textContent = `${exercise} (${sets.length} sets) logged successfully!`;
                feedbackMessage.classList.remove('hidden');
                logForm.reset();
                setsContainer.innerHTML = ''; // Clear sets container
                addSetRow(); // Add back one initial row
                // Automatically switch to history view after logging
                showView('history');
            } else {
                feedbackMessage.textContent = `Error logging workout.`;
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600', 'hidden');
            }

            logButton.disabled = false;
            logButton.textContent = 'Log Workout';

            setTimeout(() => {
                feedbackMessage.classList.add('hidden');
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
            }, 5000);
        });

        // Initialize on window load
        window.onload = function() {
            showMessage("Starting Firebase initialization...");
            initFirebase();
            setFilter('all'); // Set default filter
        };

    </script>
</body>
</html>
