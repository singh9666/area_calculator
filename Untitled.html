<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Gym Log</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
        /* Style for the Authentication Modal */
        #auth-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col items-center p-4 sm:p-8">

        <!-- Header -->
        <header class="w-full max-w-2xl text-center mb-8 flex justify-center items-center relative">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Gemini Workout Tracker</h1>
            <div class="absolute top-0 right-0">
                <button id="signout-button" class="hidden text-sm text-red-500 font-medium p-2 rounded-lg hover:bg-red-50 transition duration-150 ease-in-out flex items-center">
                    <i data-lucide="log-out" class="w-4 h-4 mr-1"></i>
                    Sign Out
                </button>
            </div>
            <p id="user-info" class="absolute bottom-[-20px] text-xs text-gray-500 font-mono"></p>
        </header>

        <!-- Main Content Wrapper (Hidden until authenticated) -->
        <div id="main-content" class="w-full max-w-2xl space-y-8 hidden">

            <!-- Workout Log Form -->
            <section id="log-section" class="bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="dumbbell" class="w-6 h-6 mr-2 text-indigo-500"></i>
                    Log New Exercise
                </h2>
                
                <form id="log-form" class="space-y-4">
                    <!-- Exercise Name -->
                    <div>
                        <label for="exercise" class="block text-sm font-medium text-gray-700 mb-1">Exercise Name</label>
                        <input type="text" id="exercise" placeholder="e.g., Barbell Bench Press" required
                               class="w-full p-3 border border-gray-300 rounded-lg transition duration-150 ease-in-out">
                    </div>

                    <!-- Sets Container -->
                    <div id="sets-container" class="space-y-3">
                        <!-- Set rows will be added here by JavaScript -->
                    </div>

                    <!-- Add Set Button -->
                    <button type="button" onclick="addSetRow()" class="w-full flex items-center justify-center p-3 text-sm font-semibold text-indigo-600 border-2 border-dashed border-indigo-300 rounded-lg hover:bg-indigo-50 transition duration-150 ease-in-out">
                        <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Add Another Set
                    </button>

                    <!-- Feedback Message -->
                    <p id="feedback-message" class="hidden text-sm font-medium pt-2 text-green-600">Workout Logged!</p>

                    <!-- Log Button -->
                    <button type="submit" id="log-button" disabled
                            class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        Log Workout
                    </button>
                </form>
            </section>

            <!-- History Section -->
            <section id="history-section" class="bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="list-checks" class="w-6 h-6 mr-2 text-indigo-500"></i>
                    Workout History
                </h2>
                <div id="history-list" class="space-y-4">
                    <p id="loading-history" class="text-gray-500 text-center">Loading history...</p>
                </div>
            </section>
        </div>

    </div>

    <!-- Authentication Modal Overlay (Initially shown if not logged in) -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="auth-title">Sign In</h3>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="auth-email" placeholder="email@example.com" required
                           class="w-full p-3 border border-gray-300 rounded-lg transition duration-150">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="auth-password" placeholder="Min 6 characters" required minlength="6"
                           class="w-full p-3 border border-gray-300 rounded-lg transition duration-150">
                </div>
                
                <p id="auth-error" class="text-sm text-red-500 hidden"></p>

                <button type="submit" id="auth-submit-button"
                        class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out">
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <button id="toggle-auth-mode" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                    Need an account? Sign Up
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase Imports and Script Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // initialAuthToken is no longer used for permanent login

        let db, auth, userId;
        const app = firebaseConfig ? initializeApp(firebaseConfig) : null;
        if (app) {
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Enable Firestore logging
            // Set persistence to Local to keep user logged in across sessions/devices
            setPersistence(auth, browserLocalPersistence);
        }

        // DOM elements
        const setsContainer = document.getElementById('sets-container');
        const logForm = document.getElementById('log-form');
        const logButton = document.getElementById('log-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const historyList = document.getElementById('history-list');
        const userInfo = document.getElementById('user-info');
        const authModal = document.getElementById('auth-modal');
        const mainContent = document.getElementById('main-content');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authError = document.getElementById('auth-error');
        const signoutButton = document.getElementById('signout-button');
        
        let isAuthReady = false;
        let isSigningUp = false; // State for tracking sign-in vs sign-up mode


        // --- UI & Utility Functions ---

        /**
         * Toggles the Sign In / Sign Up modes in the modal.
         */
        toggleAuthModeButton.addEventListener('click', () => {
            isSigningUp = !isSigningUp;
            authError.classList.add('hidden'); // Clear error message

            if (isSigningUp) {
                authTitle.textContent = 'Create Account';
                toggleAuthModeButton.textContent = 'Already have an account? Sign In';
                document.getElementById('auth-submit-button').textContent = 'Sign Up';
            } else {
                authTitle.textContent = 'Sign In';
                toggleAuthModeButton.textContent = 'Need an account? Sign Up';
                document.getElementById('auth-submit-button').textContent = 'Sign In';
            }
        });

        /**
         * Hides the login modal and shows the main content.
         */
        function showAppContent(uid) {
            userId = uid;
            userInfo.textContent = `User ID: ${uid}`;
            authModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
            signoutButton.classList.remove('hidden');
        }

        /**
         * Shows the login modal and hides the main content.
         */
        function showAuthModal() {
            authModal.classList.remove('hidden');
            mainContent.classList.add('hidden');
            signoutButton.classList.add('hidden');
            userInfo.textContent = 'Please Sign In or Register';
        }

        /**
         * Signs the user out of Firebase.
         */
        signoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });


        // --- Core Functions: Set Management (No changes needed, kept for completeness) ---

        /**
         * Creates and returns a new HTML element for a set row.
         */
        function createSetRow(setIndex) {
            const row = document.createElement('div');
            row.className = 'set-row flex items-center space-x-2';
            row.innerHTML = `
                <div class="w-10 text-center text-gray-500 font-semibold text-lg">Set ${setIndex + 1}</div>
                <input type="number" placeholder="Reps" min="1" required
                       class="w-1/3 p-2 border border-gray-300 rounded-lg transition duration-150"
                       oninput="updateLogButtonState()">
                <input type="number" placeholder="Weight (kg)" min="0" required
                       class="w-1/3 p-2 border border-gray-300 rounded-lg transition duration-150"
                       oninput="updateLogButtonState()">
                <button type="button" onclick="removeSetRow(this)" 
                        class="p-2 text-red-500 rounded-full hover:bg-red-100 transition duration-150">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;
            setTimeout(() => lucide.createIcons(), 0);
            return row;
        }

        window.addSetRow = function() {
            const setIndex = setsContainer.querySelectorAll('.set-row').length;
            setsContainer.appendChild(createSetRow(setIndex));
            updateSetNumbers();
            updateLogButtonState();
        }

        window.removeSetRow = function(button) {
            const row = button.closest('.set-row');
            if (row) {
                row.remove();
                updateSetNumbers();
                updateLogButtonState();
            }
        }
        
        function updateSetNumbers() {
            const setRows = setsContainer.querySelectorAll('.set-row');
            setRows.forEach((row, index) => {
                row.querySelector('div').textContent = `Set ${index + 1}`;
            });
        }
        
        // --- Button Validation Logic ---

        function checkFormValidity() {
            const exercise = document.getElementById('exercise').value.trim();
            if (!exercise) return false;

            const setRows = setsContainer.querySelectorAll('.set-row');
            if (setRows.length === 0) return false;

            let hasValidSet = false;
            setRows.forEach(row => {
                const repsInput = row.querySelector('input[placeholder="Reps"]');
                const weightInput = row.querySelector('input[placeholder="Weight (kg)"]');

                const reps = parseInt(repsInput.value.trim());
                const weight = parseFloat(weightInput.value.trim());

                if (!isNaN(reps) && reps > 0 && !isNaN(weight) && weight >= 0) {
                    hasValidSet = true;
                }
            });

            return hasValidSet;
        }

        window.updateLogButtonState = function() {
            if (checkFormValidity()) {
                logButton.disabled = false;
            } else {
                logButton.disabled = true;
            }
        }

        function attachValidationListeners() {
            document.getElementById('exercise').addEventListener('input', updateLogButtonState);
            setsContainer.addEventListener('input', updateLogButtonState); 
            
            const addSetButton = document.querySelector('button[onclick="addSetRow()"]');
            if (addSetButton) {
                 addSetButton.addEventListener('click', updateLogButtonState);
            } else {
                console.warn("Could not find 'Add Another Set' button for listener.");
            }
        }
        
        // --- Core Functions: Data & Saving (No changes needed, kept for completeness) ---

        async function saveWorkout(workoutData) {
            if (!db || !userId) {
                console.error("Database or User ID is not ready. Cannot save data.");
                return;
            }
            
            try {
                const workoutsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'workouts');
                await addDoc(workoutsCollectionRef, workoutData);
                console.log("Document successfully written!");

                feedbackMessage.textContent = 'Workout Logged successfully!';
                feedbackMessage.classList.remove('hidden', 'text-red-600');
                feedbackMessage.classList.add('text-green-600');

            } catch (error) {
                console.error("Error writing document: ", error);
                
                feedbackMessage.textContent = 'Error logging workout. See console for details.';
                feedbackMessage.classList.remove('hidden', 'text-green-600');
                feedbackMessage.classList.add('text-red-600');
            }

            setTimeout(() => {
                feedbackMessage.classList.add('hidden');
                feedbackMessage.classList.remove('text-red-600', 'text-green-600');
            }, 5000);
        }

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            logButton.disabled = true;
            logButton.textContent = 'Saving...';

            const exerciseName = document.getElementById('exercise').value.trim();
            const setRows = setsContainer.querySelectorAll('.set-row');
            
            const sets = [];
            setRows.forEach(row => {
                const reps = parseInt(row.querySelector('input[placeholder="Reps"]').value.trim());
                const weight = parseFloat(row.querySelector('input[placeholder="Weight (kg)"]').value.trim());

                if (!isNaN(reps) && reps > 0 && !isNaN(weight) && weight >= 0) {
                    sets.push({ reps, weight });
                }
            });

            const workoutData = {
                exercise: exerciseName,
                sets: sets,
                timestamp: new Date().getTime(),
                date: new Date().toLocaleDateString()
            };

            await saveWorkout(workoutData);

            logForm.reset();
            setsContainer.innerHTML = '';
            addSetRow();
            logButton.textContent = 'Log Workout';
        });

        // --- History Display Logic (No changes needed, kept for completeness) ---

        function renderHistory(workouts) {
            historyList.innerHTML = ''; 

            if (workouts.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center p-4">No workouts logged yet. Start lifting!</p>';
                return;
            }

            workouts.sort((a, b) => b.timestamp - a.timestamp);

            workouts.forEach(workout => {
                const workoutElement = document.createElement('div');
                workoutElement.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                
                const formattedDate = new Date(workout.timestamp).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                let setsHTML = workout.sets.map((set, index) => `
                    <li class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Set ${index + 1}:</span>
                        <span class="font-medium">${set.reps} reps @ ${set.weight} kg</span>
                    </li>
                `).join('');

                workoutElement.innerHTML = `
                    <div class="font-bold text-lg text-indigo-700">${workout.exercise}</div>
                    <div class="text-xs text-gray-500 mb-2">${formattedDate}</div>
                    <ul class="space-y-1 mt-2 p-2 bg-white rounded-md border border-gray-100">
                        ${setsHTML}
                    </ul>
                `;

                historyList.appendChild(workoutElement);
            });
        }
        
        function startHistoryListener() {
            if (!db || !userId) {
                console.error("Cannot start listener: DB or User ID unavailable.");
                historyList.innerHTML = '<p class="text-red-500 text-center p-4">Please log in to view history.</p>';
                return;
            }
            
            const workoutsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'workouts');
            const workoutsQuery = query(workoutsCollectionRef);

            onSnapshot(workoutsQuery, (snapshot) => {
                const workouts = [];
                snapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });
                renderHistory(workouts);
            }, (error) => {
                console.error("Error listening to history data: ", error);
                historyList.innerHTML = '<p class="text-red-500 text-center p-4">Error loading history.</p>';
            });
        }
        
        // --- New: Email/Password Authentication Handler ---

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!auth) {
                authError.textContent = "Cannot connect to Firebase Auth. Check console for initialization errors.";
                authError.classList.remove('hidden');
                return;
            }

            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const submitButton = document.getElementById('auth-submit-button');
            
            authError.classList.add('hidden'); // Clear previous errors
            submitButton.disabled = true;
            submitButton.textContent = isSigningUp ? 'Registering...' : 'Signing In...';

            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                // AuthStateChanged handles the success case (UI update)
            } catch (error) {
                let errorMessage = "An unknown error occurred.";
                // Map common Firebase errors to user-friendly messages
                switch (error.code) {
                    case 'auth/operation-not-allowed':
                        errorMessage = "Authentication failed. The **Email/Password provider is disabled** in your Firebase project settings. You must enable it in the Firebase Console under **Authentication -> Sign-in method**.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "Invalid email address format.";
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Invalid email or password.";
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = "This email is already registered. Please sign in.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Password should be at least 6 characters.";
                        break;
                    default:
                        console.error("Auth Error:", error);
                        errorMessage = error.message;
                        break;
                }
                authError.textContent = errorMessage;
                authError.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = isSigningUp ? 'Sign Up' : 'Sign In';
            }
        });


        // --- Final Initialization and State Listener ---

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in (Email/Password)
                    showAppContent(user.uid);
                    
                    if (setsContainer.querySelectorAll('.set-row').length === 0) {
                        addSetRow();
                    }

                    if (!isAuthReady) {
                        // Only run once on first successful login
                        attachValidationListeners(); 
                        updateLogButtonState();
                        startHistoryListener();
                        isAuthReady = true;
                    }
                } else {
                    // User is signed out
                    showAuthModal();
                    isAuthReady = false; // Reset auth ready state for next login
                }
            });
        } else {
            // Fallback for when Firebase is not initialized (e.g., missing __firebase_config on GitHub/locally)
            console.error("Firebase configuration not found. Cannot start Authentication Listener.");
            showAuthModal();
            authTitle.textContent = 'App Configuration Error';
            authError.textContent = "This app requires a secure Firebase configuration to run fully. If viewing on GitHub/locally, it will not function. Please use the hosting platform provided for this application.";
            authError.classList.remove('hidden');
            authForm.classList.add('hidden');
            toggleAuthModeButton.classList.add('hidden');
        }


        // Initialize Lucide icons on window load for initial elements
        window.addEventListener('load', () => {
             if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            // Add a default set row when the app loads (if Firebase is ready)
            if (auth && setsContainer.querySelectorAll('.set-row').length === 0) {
                addSetRow();
            }
        });

    </script>
</body>
</html>
