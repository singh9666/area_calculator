<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .set-input-group > input {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            flex-grow: 1;
        }
        /* Style for the searchable combobox */
        #exercise-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            z-index: 10;
        }
        .list-item:hover {
            background-color: #f0f4ff;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">Gemini Workout Tracker</h1>

        <!-- Configuration Error Message (Hidden by default) -->
        <div id="config-error" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
            <p class="font-bold">App Configuration Error</p>
            <p>This app requires a secure Firebase configuration to run fully. If viewing on GitHub/locally, it will not function unless you manually insert your Firebase credentials into the code.</p>
        </div>

        <!-- Authentication/Login View (Hidden by default) -->
        <div id="auth-view" class="flex flex-col items-center justify-center p-6 bg-white rounded-xl container-shadow max-w-md mx-auto hidden">
            <h2 id="auth-title" class="text-2xl font-semibold mb-6 text-gray-800">Sign In</h2>
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <p id="auth-error-message" class="text-red-500 mb-4 hidden"></p>
            <button id="auth-button" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">Sign In</button>
            <button id="toggle-auth-mode" class="mt-4 text-sm text-indigo-600 hover:text-indigo-800">Need an account? Sign Up</button>
        </div>

        <!-- Workout Logging View (Hidden by default) -->
        <div id="workout-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <p id="user-display" class="text-lg font-medium text-gray-700"></p>
                <button id="sign-out-button" class="bg-red-500 text-white text-sm py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200">Sign Out</button>
            </div>
            
            <!-- Exercise List Management (New Section) -->
            <div class="bg-white p-6 rounded-xl container-shadow mb-8">
                <button onclick="toggleExerciseManager()" class="w-full text-left flex justify-between items-center text-xl font-semibold text-gray-800 focus:outline-none">
                    <span>Manage My Exercise List</span>
                    <span id="manager-toggle-icon" class="transform transition duration-300">+</span>
                </button>
                
                <div id="exercise-manager" class="mt-4 space-y-4 hidden pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700">Add New Exercise</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="new-exercise-input" placeholder="e.g., Bulgarian Split Squat" 
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="add-exercise-button" class="bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-200">Add</button>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mt-6">Current Exercises</h3>
                    <div id="current-exercise-list" class="space-y-2">
                        <!-- List of user's exercises will be rendered here -->
                        <p id="list-loading-message" class="text-gray-500">Loading custom list...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl container-shadow mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Log New Workout</h2>
                
                <form id="log-form">
                    <!-- Exercise Name/Selector -->
                    <div class="mb-4 relative">
                        <label for="exercise" class="block text-sm font-medium text-gray-700 mb-1">Exercise Name (Searchable)</label>
                        <input type="text" id="exercise" placeholder="Start typing exercise name..." autocomplete="off" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <div id="exercise-list" class="absolute w-full bg-white rounded-b-lg shadow-lg hidden">
                            <!-- Search results go here -->
                        </div>
                    </div>

                    <!-- Sets Container -->
                    <div id="sets-container" class="space-y-3 mb-6">
                        <!-- Sets will be added here by JavaScript -->
                    </div>
                    
                    <button type="button" onclick="addSetRow()" class="flex items-center text-sm text-indigo-600 hover:text-indigo-700 transition duration-200 mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Another Set
                    </button>

                    <!-- Feedback Message -->
                    <p id="feedback-message" class="text-green-600 mb-4 font-medium hidden"></p>
                    
                    <button type="submit" id="log-button" disabled 
                            class="w-full bg-indigo-500 text-white p-3 rounded-lg font-semibold disabled:opacity-50 transition duration-200">
                        Log Workout
                    </button>
                </form>
            </div>

            <!-- Workout History -->
            <div class="bg-white p-6 rounded-xl container-shadow">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Workout History</h2>
                <div id="history-container" class="space-y-6">
                    <p id="loading-history" class="text-gray-500 text-center">Loading history...</p>
                    <!-- History will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to help with debugging
        setLogLevel('Debug');

        // Global Firebase variables
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;
        let isAuthReady = false;
        
        // Exercise List State
        let currentExerciseList = [];

        // DOM Elements for Logging/History
        const authView = document.getElementById('auth-view');
        const workoutView = document.getElementById('workout-view');
        const configError = document.getElementById('config-error');
        const logForm = document.getElementById('log-form');
        const setsContainer = document.getElementById('sets-container');
        const logButton = document.getElementById('log-button');
        const historyContainer = document.getElementById('history-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const userDisplay = document.getElementById('user-display');
        const signOutButton = document.getElementById('sign-out-button');
        const exerciseInput = document.getElementById('exercise');
        const exerciseList = document.getElementById('exercise-list');
        
        // DOM Elements for Auth
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authButton = document.getElementById('auth-button');
        const authTitle = document.getElementById('auth-title');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authErrorMessage = document.getElementById('auth-error-message');
        
        // DOM Elements for Exercise Management
        const exerciseManager = document.getElementById('exercise-manager');
        const managerToggleIcon = document.getElementById('manager-toggle-icon');
        const newExerciseInput = document.getElementById('new-exercise-input');
        const addExerciseButton = document.getElementById('add-exercise-button');
        const currentExerciseListContainer = document.getElementById('current-exercise-list');
        const listLoadingMessage = document.getElementById('list-loading-message');

        // Authentication Mode State
        let isSigningUp = false;

        // --- USER CONFIGURATION START ---
        // 1. If running outside the Canvas (e.g., GitHub Pages), replace the object below 
        //    with your actual Firebase configuration object.
        // 2. IMPORTANT: You must also enable **Email/Password** sign-in in your Firebase Console
        //    under Authentication -> Sign-in method.
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBuFnHHyghKrq0cift2_DTjpoXNWo9Dwqw",
            authDomain: "gymlog-3ef3b.firebaseapp.com",
            projectId: "gymlog-3ef3b",
            storageBucket: "gymlog-3ef3b.firebasestorage.app",
            messagingSenderId: "139587565969",
            appId: "1:139587565969:web:90bf938d213afbc81e0230",
            measurementId: "G-5DZYYM4YN2"
        };
        
        // Use a static App ID for local/GitHub hosting to match Firestore path rules
        const CUSTOM_APP_ID = "gymlog-3ef3b";
        // --- USER CONFIGURATION END ---

        // Determine which config to use (Canvas provided or custom)
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : CUSTOM_APP_ID;
        
        // Document path helper for the exercise list
        const EXERCISE_DOC_REF = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'config', 'exercise_list');

        // Check if config is present before initializing
        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                // Show config error if initialization itself fails (e.g. bad config)
                workoutView.classList.add('hidden');
                authView.classList.add('hidden');
                configError.classList.remove('hidden');
            }
        }

        // --- Default Exercise List ---
        const DEFAULT_EXERCISE_LIST = [
            "Bench Press", "Squat", "Deadlift", "Overhead Press", "Barbell Row",
            "Pull-ups", "Chin-ups", "Dips", "Lateral Raise", "Bicep Curl",
            "Tricep Extension", "Leg Press", "Leg Extension", "Leg Curl", "Calf Raise",
            "Shoulder Press (Dumbbell)", "Incline Press (Dumbbell)", "Cable Crossover",
            "Seated Cable Row", "Face Pulls", "Hanging Leg Raise", "Plank",
            "Treadmill Run", "Elliptical", "Bike Ride", "Hip Thrust", "Romanian Deadlift"
        ];
        // --- End Default Exercise List ---


        // --- Core App Logic ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    // Logged In
                    userId = user.uid;
                    userDisplay.textContent = `User ID: ${user.uid.substring(0, 8)}... (Logged in)`;
                    
                    authView.classList.add('hidden');
                    workoutView.classList.remove('hidden');
                    configError.classList.add('hidden');

                    // Setup the view (clear form, load initial set, attach listeners)
                    logForm.reset();
                    setsContainer.innerHTML = '';
                    addSetRow();
                    updateLogButtonState();
                    attachValidationListeners();

                    // NEW: Setup the listener for the custom exercise list
                    setupExerciseListListener();
                    
                    // Start listening to the database
                    setupRealtimeHistory();
                } else {
                    // Logged Out
                    userId = null;
                    userDisplay.textContent = 'Guest';
                    
                    authView.classList.remove('hidden');
                    workoutView.classList.add('hidden');
                    configError.classList.add('hidden');
                    
                    // Reset auth view to Sign In mode
                    isSigningUp = false;
                    updateAuthView();
                }
            });
        } else {
            // Configuration Error (runs when auth is null because config was missing)
            workoutView.classList.add('hidden');
            authView.classList.add('hidden');
            configError.classList.remove('hidden');
        }

        // --- Authentication/UI Functions ---

        /**
         * Switches between Sign In and Sign Up modes.
         */
        function toggleAuthMode() {
            isSigningUp = !isSigningUp;
            authErrorMessage.classList.add('hidden');
            updateAuthView();
        }

        function updateAuthView() {
            authTitle.textContent = isSigningUp ? 'Sign Up' : 'Sign In';
            authButton.textContent = isSigningUp ? 'Register' : 'Sign In';
            toggleAuthModeButton.textContent = isSigningUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up';
        }

        /**
         * Handles Sign In or Sign Up based on the current mode.
         */
        async function handleAuth() {
            authErrorMessage.classList.add('hidden');
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!email || !password) {
                authErrorMessage.textContent = 'Please enter both email and password.';
                authErrorMessage.classList.remove('hidden');
                return;
            }

            authButton.disabled = true;
            authButton.textContent = isSigningUp ? 'Registering...' : 'Signing In...';

            try {
                if (isSigningUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                // AuthStateChanged listener will handle the UI switch on success
            } catch (error) {
                console.error("Auth Error:", error);
                let message = error.message;

                // Provide user-friendly messages for common errors
                if (error.code === 'auth/operation-not-allowed') {
                     message = "Auth Error: Email/Password sign-in is disabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.";
                } else if (error.code === 'auth/weak-password') {
                    message = "Password is too weak. Must be at least 6 characters.";
                } else if (error.code === 'auth/email-already-in-use') {
                    message = "This email is already registered. Try signing in.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "The email address is not valid.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = "Invalid email or password.";
                }
                
                authErrorMessage.textContent = message;
                authErrorMessage.classList.remove('hidden');
            } finally {
                authButton.disabled = false;
                authButton.textContent = isSigningUp ? 'Register' : 'Sign In';
            }
        }
        
        authButton.addEventListener('click', handleAuth);
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);

        // Sign Out Listener
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        });

        // --- Form Management and Validation ---

        /**
         * Adds a new set row to the form.
         */
        window.addSetRow = function() {
            const index = setsContainer.querySelectorAll('.set-row').length + 1;
            const newRow = document.createElement('div');
            newRow.className = 'set-row flex space-x-2 items-center';
            newRow.innerHTML = `
                <span class="font-semibold text-gray-700 w-8 flex-shrink-0">Set ${index}</span>
                <div class="flex space-x-2 set-input-group flex-grow">
                    <input type="number" min="0" step="1" placeholder="Reps" class="w-1/2" required>
                    <input type="number" min="0" step="0.1" placeholder="Weight (kg)" class="w-1/2" required>
                </div>
                <button type="button" class="remove-set-btn text-red-500 hover:text-red-700 p-2 rounded-full flex-shrink-0" onclick="removeSetRow(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            setsContainer.appendChild(newRow);
            updateLogButtonState(); // Re-check button state after adding
            updateSetNumbers();
        }

        /**
         * Removes a specific set row and re-numbers the remaining rows.
         */
        window.removeSetRow = function(button) {
            button.closest('.set-row').remove();
            updateSetNumbers();
            updateLogButtonState(); // Re-check button state after removing
        }

        /**
         * Re-numbers the set labels after an addition or removal.
         */
        function updateSetNumbers() {
            setsContainer.querySelectorAll('.set-row').forEach((row, index) => {
                row.querySelector('span').textContent = `Set ${index + 1}`;
            });
        }
        
        /**
         * Checks if the entire form has valid data for logging.
         */
        function checkFormValidity() {
            const exercise = exerciseInput.value.trim();
            if (!exercise) return false;

            const setRows = setsContainer.querySelectorAll('.set-row');
            if (setRows.length === 0) return false;

            let hasValidSet = false;
            setRows.forEach(row => {
                const repsInput = row.querySelector('input[placeholder="Reps"]');
                const weightInput = row.querySelector('input[placeholder="Weight (kg)"]');

                const reps = parseInt(repsInput.value.trim());
                const weight = parseFloat(weightInput.value.trim());

                // A set is valid if both reps and weight are entered as positive numbers
                if (!isNaN(reps) && reps > 0 && !isNaN(weight) && weight >= 0) {
                    hasValidSet = true;
                }
            });

            return hasValidSet;
        }

        /**
         * Toggles the disabled state of the Log Workout button based on form validity.
         */
        function updateLogButtonState() {
            if (logButton) {
                logButton.disabled = !checkFormValidity();
            }
        }

        /**
         * Attaches event listeners to form fields to trigger the button state update.
         */
        function attachValidationListeners() {
            exerciseInput.addEventListener('input', updateLogButtonState);
            setsContainer.addEventListener('input', updateLogButtonState);
        }

        // --- Exercise Selector Logic (Now uses currentExerciseList) ---
        
        /**
         * Filters the list and updates the combobox display.
         */
        exerciseInput.addEventListener('input', () => {
            const query = exerciseInput.value.toLowerCase();
            exerciseList.innerHTML = '';

            if (query.length > 0) {
                // Use the dynamic currentExerciseList
                const filtered = currentExerciseList.filter(ex => ex.toLowerCase().includes(query));
                
                if (filtered.length > 0) {
                    filtered.slice(0, 5).forEach(ex => {
                        const item = document.createElement('div');
                        item.className = 'list-item p-2 border-b border-gray-200';
                        item.textContent = ex;
                        item.addEventListener('click', () => {
                            exerciseInput.value = ex;
                            exerciseList.classList.add('hidden');
                            updateLogButtonState();
                        });
                        exerciseList.appendChild(item);
                    });
                    exerciseList.classList.remove('hidden');
                } else {
                    exerciseList.classList.add('hidden');
                }
            } else {
                exerciseList.classList.add('hidden');
            }
        });
        
        // Hide list when input loses focus (with a slight delay to allow clicking an item)
        exerciseInput.addEventListener('blur', () => {
             setTimeout(() => {
                 if (exerciseList) exerciseList.classList.add('hidden');
             }, 200);
        });

        // Show list when input gains focus if text is present
        exerciseInput.addEventListener('focus', () => {
            if (exerciseInput.value.length > 0 || currentExerciseList.length > 0) {
                exerciseInput.dispatchEvent(new Event('input')); // Re-run filter logic
            }
        });

        // --- Exercise List Management Logic ---

        window.toggleExerciseManager = function() {
            const isHidden = exerciseManager.classList.contains('hidden');
            if (isHidden) {
                exerciseManager.classList.remove('hidden');
                managerToggleIcon.classList.add('rotate-45');
            } else {
                exerciseManager.classList.add('hidden');
                managerToggleIcon.classList.remove('rotate-45');
            }
        }

        /**
         * Sets up a real-time listener for the user's custom exercise list in Firestore.
         */
        function setupExerciseListListener() {
            if (!db || !userId) return;

            onSnapshot(EXERCISE_DOC_REF(userId), async (docSnapshot) => {
                let fetchedList = [];
                if (docSnapshot.exists() && docSnapshot.data().exercises) {
                    fetchedList = docSnapshot.data().exercises;
                } else {
                    // If document doesn't exist, initialize with defaults
                    console.log("No custom exercise list found. Initializing with defaults.");
                    fetchedList = DEFAULT_EXERCISE_LIST;
                    // Save the defaults immediately so the user can modify them
                    await setDoc(EXERCISE_DOC_REF(userId), { exercises: DEFAULT_EXERCISE_LIST }, { merge: false });
                }

                // Update the state and sort it alphabetically
                currentExerciseList = fetchedList.sort((a, b) => a.localeCompare(b)); 
                renderManagerList();
                // Re-trigger the search input update in case the list changed while typing
                exerciseInput.dispatchEvent(new Event('input')); 

            }, (error) => {
                console.error("Error loading exercise list: ", error);
                currentExerciseListContainer.innerHTML = `<p class="text-red-500">Failed to load list.</p>`;
            });
        }
        
        /**
         * Saves the new list back to Firestore.
         */
        async function saveExerciseList(list) {
            if (!db || !userId) return;
            try {
                // setDoc will overwrite the list with the new array
                await setDoc(EXERCISE_DOC_REF(userId), { exercises: list }, { merge: false });
            } catch (error) {
                console.error("Error saving exercise list: ", error);
            }
        }
        
        /**
         * Adds a new exercise from the input field.
         */
        function addExercise() {
            const newEx = newExerciseInput.value.trim();
            // Check if the exercise is already in the list (case-insensitive)
            if (newEx && !currentExerciseList.map(e => e.toLowerCase()).includes(newEx.toLowerCase())) {
                const newList = [...currentExerciseList, newEx];
                newExerciseInput.value = ''; // Clear input
                saveExerciseList(newList); // saveExerciseList will trigger onSnapshot, updating state and UI
            } else if (newEx) {
                // Simple feedback for duplicates
                newExerciseInput.value = '';
                newExerciseInput.placeholder = "Already exists!";
                setTimeout(() => newExerciseInput.placeholder = "e.g., Bulgarian Split Squat", 1500);
            }
        }

        /**
         * Deletes a specific exercise from the list.
         */
        window.deleteExercise = function(exerciseToDelete) {
            // Use strict comparison for deletion
            const newList = currentExerciseList.filter(ex => ex !== exerciseToDelete);
            saveExerciseList(newList);
        }

        /**
         * Renders the current exercise list in the management panel.
         */
        function renderManagerList() {
            listLoadingMessage.classList.add('hidden');
            currentExerciseListContainer.innerHTML = '';

            if (currentExerciseList.length === 0) {
                currentExerciseListContainer.innerHTML = `<p class="text-gray-500 p-2 border border-gray-200 rounded-lg">Your custom list is empty. Add exercises above!</p>`;
                return;
            }

            currentExerciseList.forEach(ex => {
                // We use replace to safely handle single quotes in exercise names when passing to the onclick handler
                const safeEx = ex.replace(/'/g, "\\'"); 
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-700 font-medium">${ex}</span>
                    <button class="delete-workout-btn text-red-500 hover:text-red-700 transition duration-200 ml-4 p-1"
                            data-id="${ex}" onclick="deleteExercise('${safeEx}')" title="Delete Exercise">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                currentExerciseListContainer.appendChild(item);
            });
        }
        
        // Event listeners for exercise management
        addExerciseButton.addEventListener('click', addExercise);
        newExerciseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addExercise();
            }
        });
        
        // --- Firestore Saving Logic (Unchanged) ---

        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (logButton.disabled) return;
            
            logButton.disabled = true;
            logButton.textContent = 'Saving...';
            feedbackMessage.classList.add('hidden');

            const exerciseName = exerciseInput.value.trim();
            const setRows = setsContainer.querySelectorAll('.set-row');
            
            // Build the sets array
            const sets = [];
            setRows.forEach(row => {
                const repsInput = row.querySelector('input[placeholder="Reps"]');
                const weightInput = row.querySelector('input[placeholder="Weight (kg)"]');

                const reps = parseInt(repsInput.value.trim());
                const weight = parseFloat(weightInput.value.trim());

                if (!isNaN(reps) && reps > 0 && !isNaN(weight) && weight >= 0) {
                    sets.push({ reps, weight });
                }
            });

            const workoutData = {
                exercise: exerciseName,
                sets: sets,
                timestamp: serverTimestamp() 
            };

            const workoutsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'workouts');

            try {
                await addDoc(workoutsCollectionRef, workoutData);
                
                // Success feedback
                feedbackMessage.textContent = 'Workout logged successfully!';
                feedbackMessage.classList.remove('text-red-600', 'hidden');
                feedbackMessage.classList.add('text-green-600');
                
                // Reset form (keep one empty set row)
                logForm.reset();
                setsContainer.innerHTML = '';
                addSetRow();
                updateLogButtonState();

            } catch (error) {
                console.error("Error writing document: ", error);
                
                // Failure feedback
                feedbackMessage.textContent = 'Error logging workout. Check console for details.';
                feedbackMessage.classList.remove('text-green-600', 'hidden');
                feedbackMessage.classList.add('text-red-600');
                
            } finally {
                // Ensure the button is re-enabled regardless of success/failure
                logButton.textContent = 'Log Workout';
                updateLogButtonState(); 
                
                setTimeout(() => {
                    feedbackMessage.classList.add('hidden');
                    feedbackMessage.classList.remove('text-red-600');
                    feedbackMessage.classList.add('text-green-600');
                }, 5000);
            }
        });

        // --- Firestore Reading and Deleting Logic (Unchanged) ---

        function setupRealtimeHistory() {
            if (!db || !userId) return;

            const workoutsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'workouts');
            
            // Query: Get all workouts, ordered by timestamp descending
            const q = query(workoutsCollectionRef, orderBy('timestamp', 'desc'));

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                const workouts = [];
                snapshot.forEach(doc => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });

                renderHistory(workouts);
            }, (error) => {
                console.error("Error reading history: ", error);
                historyContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load history: ${error.message}</p>`;
            });
        }

        function renderHistory(workouts) {
            historyContainer.innerHTML = ''; // Clear existing history
            document.getElementById('loading-history').classList.add('hidden');
            
            if (workouts.length === 0) {
                historyContainer.innerHTML = `<p class="text-gray-500 text-center p-4">No workouts logged yet. Go lift something!</p>`;
                return;
            }

            workouts.forEach(workout => {
                // Format the date
                const date = workout.timestamp ? new Date(workout.timestamp.seconds * 1000).toLocaleString() : 'Saving...';
                
                // Build sets list
                const setsHtml = workout.sets.map((set, index) => `
                    <div class="flex justify-between text-sm text-gray-600 border-b border-gray-100 py-1">
                        <span>Set ${index + 1}</span>
                        <span>${set.reps} Reps @ ${set.weight} kg</span>
                    </div>
                `).join('');

                const workoutElement = document.createElement('div');
                workoutElement.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                workoutElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="text-xl font-bold text-indigo-700">${workout.exercise}</h3>
                        <div class="flex items-center space-x-2">
                            <p class="text-sm text-gray-500">${date}</p>
                            <button class="delete-workout-btn text-red-500 hover:text-red-700 transition duration-200" 
                                    data-id="${workout.id}" onclick="deleteWorkout('${workout.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    ${setsHtml}
                `;
                historyContainer.appendChild(workoutElement);
            });
        }
        
        /**
         * Deletes a workout document from Firestore.
         */
        window.deleteWorkout = async function(docId) {
            if (!db || !userId) return;

            // Use a confirmation prompt instead of window.confirm
            const userInput = prompt("To confirm deletion, type 'DELETE' below:");
            if (userInput !== 'DELETE') return;
            
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'workouts', docId);

            try {
                await deleteDoc(docRef);
                console.log(`Workout document ${docId} successfully deleted.`);
            } catch (error) {
                console.error("Error deleting document: ", error);
                // Logging final error to console to comply with the strict rule against alert/confirm
                console.error('Failed to delete workout. Please check your Firestore security rules.');
            }
        }
        
    </script>
</body>
</html>
